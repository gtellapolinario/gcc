services:
  gcc-mcp:
    image: ghcr.io/codeadminde/gcc:latest
    container_name: gcc-mcp
    command:
      - --transport
      - streamable-http
      - --host
      # Container-internal binding; exposure is controlled by host loopback publish below.
      - 0.0.0.0
      - --port
      - "8000"
    environment:
      PYTHONUNBUFFERED: "1"
      # Required because container listens on 0.0.0.0 internally.
      # Exposure remains loopback-only via `127.0.0.1:8000:8000` below.
      GCC_MCP_ALLOW_PUBLIC_HTTP: "true"
      GCC_MCP_SECURITY_PROFILE: strict
      GCC_MCP_AUTH_MODE: ${GCC_MCP_AUTH_MODE:-token}
      GCC_MCP_AUTH_TOKEN: ${GCC_MCP_AUTH_TOKEN:?set GCC_MCP_AUTH_TOKEN in environment or .env}
      GCC_MCP_AUTH_REQUIRED_SCOPES: ${GCC_MCP_AUTH_REQUIRED_SCOPES:-}
      GCC_MCP_AUDIT_LOG: /var/log/gcc/server-audit.jsonl
      GCC_MCP_AUDIT_REDACT: "true"
      GCC_MCP_AUDIT_SIGNING_KEY_FILE: /run/secrets/audit_signing_key
      GCC_MCP_AUDIT_SIGNING_KEY_ID: ${GCC_MCP_AUDIT_SIGNING_KEY_ID:-prod-2026-q1}
      GCC_MCP_RATE_LIMIT_PER_MINUTE: ${GCC_MCP_RATE_LIMIT_PER_MINUTE:-120}
      GCC_MCP_AUDIT_MAX_FIELD_CHARS: ${GCC_MCP_AUDIT_MAX_FIELD_CHARS:-4000}
      GCC_MCP_PATH_MAP: ${GCC_MCP_PATH_MAP:-}
      GCC_MCP_ALLOWED_ROOTS: ${GCC_MCP_ALLOWED_ROOTS:-}
    ports:
      # Keep direct MCP HTTP local-only; terminate TLS and publish externally via reverse proxy.
      - "127.0.0.1:8000:8000"
    volumes:
      - gcc-workspace:/workspace
      - gcc-logs:/var/log/gcc
    secrets:
      - audit_signing_key
    read_only: true
    tmpfs:
      - /tmp
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 8000)); s.close()\"",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

volumes:
  gcc-workspace:
  gcc-logs:

secrets:
  audit_signing_key:
    file: ./secrets/audit-signing.key
